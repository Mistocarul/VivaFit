<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Confirm Registration</title>
    <style>
        /* Stiluri similare */
        .error-message {
            color: red;
        }
        .success-message {
            color: green;
        }
    </style>
</head>
<body>
<div class="login-container">
    <h2>Confirm Registration</h2>
    <form id="confirmForm">
        <input type="hidden" id="username" name="username">

        <label for="code">Confirmation Code:</label>
        <input type="text" id="code" name="code" required>

        <button type="submit">Confirm</button>
        <button type="button" id="cancelButton">Cancel</button>
    </form>
    <div id="error-message" class="error-message"></div>
    <div id="success-message" class="success-message"></div>
    <pre id="response-details"></pre> <!-- Aici se vor afișa detaliile răspunsului -->
</div>

<script>
    // Setează username-ul din query string
    const username = new URLSearchParams(window.location.search).get('username');
    document.getElementById('username').value = username;

    document.getElementById('confirmForm').addEventListener('submit', function(event) {
        event.preventDefault();

        const formData = new FormData(this);
        const jsonObject = {};
        formData.forEach((value, key) => {
            jsonObject[key] = value;
        });

        fetch('http://localhost:9090/api/auth/confirm', {
            method: 'POST',
            body: JSON.stringify(jsonObject),
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            const responseDetails = document.getElementById('response-details');
            let userDetails = '';

            if (data.user) {
                userDetails = `
                    Username: ${data.user.username}
                    Email: ${data.user.email}
                    Phone Number: ${data.user.phoneNumber}
                    Profile Picture: ${data.user.profilePicture}
                    Role: ${data.user.role}
                `;
            }

            responseDetails.textContent = `
                Message: ${data.message}
                ${userDetails}
                Redirect URL: ${data.redirectPageUrl}
            `;

            if (data.message.includes("User registered successfully")) {
                document.getElementById('success-message').textContent = data.message;
                setTimeout(() => {
                    window.location.href = data.redirectPageUrl || 'login.html'; // Redirect to the provided URL or default to 'login.html'
                }, 3000);
            } else {
                document.getElementById('error-message').textContent = data.message;
            }
        })
        .catch(error => {
            console.error('Network Error:', error);
            document.getElementById('error-message').textContent = 'Confirmation failed. Please try again.';
        });
    });

    // Adaugă un eveniment pentru butonul de Cancel
    document.getElementById('cancelButton').addEventListener('click', function() {
        const cancelData = {
            username: document.getElementById('username').value,
            code: 000000 // Codul de anulare este 000000
        };

        fetch('http://localhost:9090/api/auth/cancel', {
            method: 'POST',
            body: JSON.stringify(cancelData),
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.message) {
                document.getElementById('success-message').textContent = data.message;
                setTimeout(() => {
                    window.location.href = 'login.html'; // Redirecționează către login.html
                }, 3000);
            } else {
                document.getElementById('error-message').textContent = 'Failed to cancel. Please try again.';
            }
        })
        .catch(error => {
            console.error('Network Error:', error);
            document.getElementById('error-message').textContent = 'Failed to cancel. Please try again.';
        });
    });
</script>
</body>
</html>
